{% extends "base.html" %}
{% load tz %}
{% load tag %}

{% block header %}
<link rel="stylesheet" href="/static/js/annotator/annotator.min.css" type="text/css" media="all" />
<script type="text/javascript" src="/static/js/annotator/annotator-full.min.js"></script>
{% if is_teacher %}
<link rel="stylesheet" href="/static/js/annotator/annotator.touch.css" type="text/css" media="all" />
<script type="text/javascript" src="/static/js/annotator/annotator.touch.min.js"></script>
{% endif %}
{% endblock %}

{% block content %}
<div class="row">
<a href="/student/forum/{{classroom_id}}/{{index}}/" class="btn btn-success" role="btn">{{subject}}</a>
<a href="/student/forum/{{classroom_id}}/{{index}}/" class="btn btn-success" role="btn">{{classroom_id|classname}}</a>
<BR>
	{% if action == "1" %}
	{% for enroll, works, replys, files in datas %}
	<a href="#{{enroll.id}}" class="seat btn {% if works.0.publish %}btn-warning{% else %}btn-default{% endif %}" role="btn">({{enroll.seat}}){{enroll.student_id|realname}}</a>
	{% endfor %}
	{% endif %}
  {% for enroll, works, replys, files in datas %}
	{% with works|last as last %}
	<a id="{{enroll.id}}"></a>
  <div class="panel panel-default">
		<div class="panel-heading">{{enroll.seat}}){{enroll.student.first_name}} {{works.0.publication_date}}　{% if works and not works.0.publish %}<font color=red>尚未發表</font>{% endif %}
			<span style="float:right">
		  {% if works.0.publish or request.user.id|is_teacher:enroll.classroom_id %}
			{% if works|length > 0 %}<A href="/student/forum/history/{{enroll.student_id}}/{{index}}/{{classroom_id}}">{% endif %}<img src="/static/images/edit.gif"> 歷史({{works|length}}){% if works|length > 0 %}</A>{% endif %}
			{% else %}
			<img src="/static/images/edit.gif"> 歷史({{works|length}}) 		
			{% endif %}
			  <a href="/account/line/add/{{classroom_id}}/{{enroll.student_id}}"><img src="/static/images/icon-email.gif">私訊</a>
				</span>		
			<!--{% if enroll.student_id == request.user.id %}<a href="/student/forum/submit/{{classroom_id}}/{{index}}" class="btn btn-primary" role="btn">編輯</a>{% endif %}-->
		</div>
		{% if works.0 or files.0 %}
			{% if works.0.publish %}
    <div class="panel-body">
			<div class="memo-content" data-userid="{{enroll.student_id}}">
				{{works.0.memo|memo|safe}}
			</div>
		<BR>
		      {% for file in files %}
			      {% if file.visible %}
		  <BR><button class="btn btn-info">
              {{forloop.revcounter}}
        </button> 
		          {{file.publication_date}}	
			        {% if file.title|is_pic %}
		<a href="/student/forum/showpic/{{file.id}}" target="_blank">{{file.title}}</a>
			        {% else %}
			<a href="/student/forum/download/{{file.id}}" target="_blank">{{file.title}}</a>
			        {% endif %}
            {% endif %}
		      {% endfor %}
    <hr>			
          {% if request.user.id in last.id|likes %}
    <a href="#" data-forumid="{{index}}" data-userid="{{ enroll.student_id }}" data-action="unlike" class="like btn btn-primary" role="btn"><span class="glyphicon glyphicon-thumbs-up" aria-hidden="true">讚</span></a>
          {% else %}
    <a href="#" data-forumid="{{index}}" data-userid="{{ enroll.student_id }}" data-action="like" class="like btn btn-default" role="btn"><span class="glyphicon glyphicon-thumbs-up" aria-hidden="true">讚</span></a>
          {% endif %}
    <a href="#" data-forumid="{{index}}" data-userid="{{ enroll.student_id }}" class="people">
    <span id="likes_count">{{last.like_count}}</span>人按讚
    </a>
    <a href="#" data-forumid="{{index}}" data-userid="{{ enroll.student_id }}" data-workid="{{last.id}}" class="btn btn-default reply" role="btn"><span class="glyphicon glyphicon-heart" aria-hidden="true">留言</span></a>

			<a href="#" data-workid="{{last.id}}" class="guestbooks">

			<span id="reply_count">{{replys|length}}</span>則留言
		</a>
<fieldset class="rating">
    <input {% if last.score == 5 %}checked{% endif %} data-workid="{{last.id}}" type="radio" {% ifnotequal request.user.id  teacher_id %} onclick="return false;"{% endifnotequal  %} id="star5_{{last.id}}" name="rating{{last.id}}" value="5"/><label class = "full" for="star5_{{last.id}}" title="太棒了 - 5顆星"></label>
    <input {% if last.score == 4 %}checked{% endif %} data-workid="{{last.id}}" type="radio" {% ifnotequal request.user.id  teacher_id %} onclick="return false;"{% endifnotequal  %} id="star4_{{last.id}}" name="rating{{last.id}}" value="4" /><label class = "full" for="star4_{{last.id}}" title="好棒 - 4顆星"></label>
    <input {% if last.score == 3 %}checked{% endif %} data-workid="{{last.id}}" type="radio" {% ifnotequal request.user.id  teacher_id %} onclick="return false;"{% endifnotequal  %} id="star3_{{last.id}}" name="rating{{last.id}}" value="3" /><label class = "full" for="star3_{{last.id}}" title="不錯 - 3顆星"></label>
    <input {% if last.score == 2 %}checked{% endif %} data-workid="{{last.id}}" type="radio" {% ifnotequal request.user.id  teacher_id %} onclick="return false;"{% endifnotequal  %} id="star2_{{last.id}}" name="rating{{last.id}}" value="2" /><label class = "full" for="star2_{{last.id}}" title="再加油 - 2顆星"></label>
    <input {% if last.score == 1 %}checked{% endif %} data-workid="{{last.id}}" type="radio" {% ifnotequal request.user.id  teacher_id %} onclick="return false;"{% endifnotequal  %} id="star1_{{last.id}}" name="rating{{last.id}}" value="1" /><label class = "full" for="star1_{{last.id}}" title="繼續努力 - 1顆星"></label>
</fieldset>
			        <div id="reply" style="display:none">
							<textarea  autofocus name="reply" id="reply_memo" cols="30" rows="5" class="form-control list-group-item-text"></textarea>
							<button class="reply_submit" data-workid={{works.0.id}} data-index={{works.0.index}} data-userid={{request.user.id}}>送出</button>

						</div>		
<div id="blockquote">
               {% for reply in replys|slice:":2" %}
<blockquote>
  <p>{{reply.memo}}</p>
  <footer>{{reply.user_id|realname}} <cite title="Source Title">{{reply.publication_date}}</cite></footer>
</blockquote>
	{% endfor %}
</div>
								</div>
	{% endif %}   

{% endif %}
				
			</div>
	{% endwith %}			
{% endfor %}

  <div class="modal fade" tabindex="-1" role="dialog" id="vidModal">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-body">
					<div>
					 <a href="#" id="closevideo" class="btn btn-default pull-right" role="btn">關閉</a>						
					</div>
            <div id="vplayer"></div>
        </div>
      </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
  </div><!-- /.modal -->
  
  <div class="modal fade" tabindex="-1" role="dialog" id="likes_people">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-body">
            <div id="people"></div>
        </div>
      </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
  </div><!-- /.modal -->
	
  <div class="modal fade" tabindex="-1" role="dialog" id="guestbook_modal">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-body">
            <div id="guestbook"></div>
        </div>
      </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
  </div><!-- /.modal -->	
{% endblock %}

{% block footer_script %}
<script>
var vidMap = {
  {% for work in contents %}
  {% if work.types == 2 %}
  'm_{{ work.id }}': '{{ work.youtube|number }}',
  {% endif %}
  {% endfor %}  
};


var vidPlayer = null;
function onPlayerReady(event) {
  event.target.playVideo();
}
function timeToSec(timestr) {
  var hh = parseInt(timestr.substr(0, 2)), 
      mm = parseInt(timestr.substr(3, 2)), 
      ss = parseInt(timestr.substr(6, 2));
    return (hh*3600)+(mm*60)+ss;
}

function onYouTubeIframeAPIReady() {
  $('.btn-marker').click(function(event) {
    var vid = vidMap['m_'+$(event.target).data('mid')];
    var tsec = timeToSec($(event.target).data('time'));
    if (!vidPlayer) {
      vidPlayer = new YT.Player('vplayer', {
        height: '315', 
        width: '560', 
        videoId: vid,
        playerVars: {
          start: tsec,
        },
        events: {
          'onReady': onPlayerReady,
        }
      });
    } else {			
			vidPlayer.stopVideo();
		  vidPlayer.loadVideoById(vid, tsec, 'large');
      vidPlayer.seekTo(tsec);	
    }
    $('#vidModal').modal('show');
  });
}

$('#vidModal').on('hidden.bs.modal', function (e) {
  vidPlayer.stopVideo();
});

$(document).ready(function () {
  //------------------------------------------------------------------------
  // Load YouTube API library
  var tag = document.createElement('script');
  tag.id = 'iframe-demo';
  tag.src = 'https://www.youtube.com/iframe_api';
  var firstScriptTag = document.getElementsByTagName('script')[0];
  firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);  

  Annotator.Plugin.Message = function (element) {
    var plugin = {};
    plugin.pluginInit = function () {
      this.annotator.viewer.addField({
        load: function (field, annotation) {
          field.innerHTML = "標註者: " + annotation.supervisor;
        }
      })
    };
    return plugin;
  }
  var re = /https?:\/\/[^\/]+([^\?]*)/;
  var page_path = re.exec(window.location.href)[1];
  $('.memo-content').each(function(index, element) {
    var userid = $(element).data('userid');
    $(element).annotator({% if not is_teacher %}
      {readOnly: true}
    {% endif %})
    .annotator('addPlugin', 'Store', {
      prefix: '/annotate', 
      annotationData: {
        'findex': {{index}},
        'stuid': userid,
      },
      loadFromSearch: {
        'findex': {{index}}, 
        'stuid': userid,
      }
    })
    .annotator('addPlugin', 'Touch')
    .annotator('addPlugin', 'Message');		
  });
});
</script>
{% endblock %}

{% block domready %}
  $('a.seat').click(function(e){
    var launcher = this;
		var url = ($(this).attr('href'));
    e.preventDefault();

		$('html, body').animate({scrollTop: $(''+url).offset().top -100 }, 'slow');

  });		
			
  $('a#closevideo').click(function(e){
    var launcher = this;  
    e.preventDefault();	  
    $('#vidModal').modal('hide');
  });		
			
  $('input:radio').change(function(e){
    var launcher = this;  
    e.preventDefault();
    $.post('/student/forum/score/',
      {
        workid: $(launcher).data('workid'),
        score: $(launcher).val(),
      },
      function(data){
        if (data['status'] == 'ok')
        {
          //alert( $(launcher).val()+"分");
        } else {
			   	alert("hello");
	    	}
      }
    );
  });    

	$('.reply_submit').click(function(e){
    var launcher = this;  
    e.preventDefault();
	  
    $.post('/student/forum/reply/',
      {
        index: $(launcher).data('index'),
        userid: $(launcher).data('userid'),
        workid: $(launcher).data('workid'),	
	      reply: $(launcher).parent().find("textarea").val()
      },
      function(data){
        if (data['status'] == 'ok')
        {
            $(launcher).parent().hide();
            blockquote = '<blockquote><p>'+ $(launcher).parent().find("textarea").val()+'</p><footer>{{request.user.id|realname}} <cite title="Source Title">'+Date().toString()+'</cite></footer></blockquote>'	
	          $(launcher).parent().parent().find("#blockquote").html(blockquote+$(launcher).parent().parent().find("#blockquote").html());
            reply_count = parseInt($(launcher).parent().parent().find('#reply_count').html()) + 1;
            $(launcher).parent().parent().find('#reply_count').html(reply_count);	

        } else {
			   	alert("hello");
	    	}
      }
    );
  });  
	
  $('a.reply').click(function(e){
    var launcher = this;  
    e.preventDefault();
	  
		$(launcher).parent().find("#reply_memo").val("");
    $(launcher).parent().find("#reply").show();
	  $(launcher).parent().find("#reply_memo").focus();
  });

  $('a.guestbooks').click(function(e){
    var launcher = this;  
    e.preventDefault();
    $.post('/student/forum/guestbook/',
      {
        workid: $(launcher).data('workid'),
      },
      function(data){
        if (data['status'] == 'ok')
        {
            $("#guestbook").html(data['replys']);
            $('#guestbook_modal').modal('show');

        } else {
			   	alert("hello");
	    	}
      }
    );
  });  
	
  $('a.people').click(function(e){
    var launcher = this;  
    e.preventDefault();
    $.post('/student/forum/people/',
      {
        forumid: $(launcher).data('forumid'),
        userid: $(launcher).data('userid'),
      },
      function(data){
        if (data['status'] == 'ok')
        {
            $("#people").html(data['likes']);
            $('#likes_people').modal('show');

        } else {
			   	alert("hello");
	    	}
      }
    );
  });  
  $('a.like').click(function(e){
    var launcher = this;  
    e.preventDefault();
    $.post('/student/forum/like/',
      {
        forumid: $(launcher).data('forumid'),
        userid: $(launcher).data('userid'),
        action: $(launcher).data('action')
      },
      function(data){
        if (data['status'] == 'ok')
        {
          var previous_action = $(launcher).data('action');
		      if (previous_action == 'like') {
               likes_count = parseInt($(launcher).parent().find('#likes_count').html()) + 1;
               $(launcher).parent().find('#likes_count').html(likes_count);
               $(launcher).removeClass("btn-default").addClass("btn-primary");
               $(launcher).data('action', 'unlike');
           } else {
               $(launcher).removeClass("btn-primary").addClass("btn-default");
               $(launcher).data('action', 'like');
               likes_count = parseInt($(launcher).parent().find('#likes_count').html()) - 1;
               $(launcher).parent().find('#likes_count').html(likes_count);
           }
        } else {
			   	alert("hello");
	    	}
      }
    );
  });
{% endblock %}